<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/socket.io/socket.io.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>East Moon KDS - Secure Kitchen Display</title>
    <style>
        /* Existing styles from your original file go here */
        
        #security-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a; z-index: 9999; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .passcode-input {
            background: #333; border: 2px solid #DC143C; color: white;
            padding: 15px; font-size: 24px; text-align: center; border-radius: 8px;
            margin-bottom: 20px; outline: none;
        }
        .bottleneck-toast {
            position: fixed; bottom: 20px; right: 20px; background: #ff4b2b;
            color: white; padding: 20px; border-radius: 12px; display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 1001;
            border: 2px solid white; animation: slideIn 0.5s ease;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body style="visibility: hidden;">

    <div id="security-overlay">
        <h2 style="color: white; margin-bottom: 20px;">KDS AUTHORIZATION REQUIRED</h2>
        <input type="password" id="passcode" class="passcode-input" placeholder="ENTER PIN">
        <button class="action-btn btn-complete" style="max-width: 200px;" onclick="checkAccess()">UNLOCK KDS</button>
    </div>

    <div id="bottleneckToast" class="bottleneck-toast">
        <strong id="bottleneckTitle">‚ö†Ô∏è BOTTLENECK DETECTED</strong><br>
        <span id="bottleneckMsg">Too many orders for one station!</span>
    </div>

    <script>
        // ============================================
        // CONFIGURATION & AUTH
        // ============================================
        const KDS_PIN = "1234"; 
        const _supabase = supabase.createClient('YOUR_SUPABASE_URL', 'YOUR_SUPABASE_KEY');

        function checkAccess() {
            const input = document.getElementById('passcode').value;
            if (input === KDS_PIN) {
                document.getElementById('security-overlay').style.display = 'none';
                document.body.style.visibility = 'visible';
                // Trigger full initialization
                initializeKDS(); 
            } else {
                alert("Unauthorized Access Denied.");
            }
        }

        // ============================================
        // SOUND ENGINE (Unique Profiles)
        // ============================================
        function playSound(type) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const sounds = {
                new: { freq: 880, type: 'sine', dur: 0.2 },       // High Pitch
                overdue: { freq: 440, type: 'sawtooth', dur: 0.5 }, // Aggressive Buzz
                lock: { freq: 1200, type: 'square', dur: 0.1 },    // Quick Click
                load: { freq: 300, type: 'triangle', dur: 0.8 },   // Low Warning
                bottleneck: { freq: 554, type: 'square', dur: 1.0 } // Alert Siren
            };

            const s = sounds[type] || sounds.new;
            osc.frequency.value = s.freq;
            osc.type = s.type;
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + s.dur);
            
            osc.start();
            osc.stop(audioCtx.currentTime + s.dur);
        }

        // ============================================
        // PERSISTENCE: LOAD FROM DATABASE
        // ============================================
        async function initializeKDS() {
            console.log("üì• Syncing with Supabase...");
            const { data, error } = await _supabase
                .from('orders')
                .select('*')
                .eq('status', 'pending');

            if (error) {
                console.error("Fetch Error:", error);
                return;
            }

            if (data) {
                orders = data.map(dbOrder => ({
                    id: dbOrder.id,
                    number: dbOrder.orderNumber,
                    source: (dbOrder.orderType || 'walkin').toLowerCase().replace(' ', ''),
                    customer: dbOrder.customerName,
                    phone: dbOrder.phoneNumber,
                    items: typeof dbOrder.orderItems === 'string' ? JSON.parse(dbOrder.orderItems) : dbOrder.orderItems,
                    status: dbOrder.status || 'new',
                    startTime: new Date(dbOrder.timestamp).getTime(),
                    promiseTime: dbOrder.orderType === 'Walk-In' ? 10 : 20,
                    locked: false,
                    timer: Math.floor((Date.now() - new Date(dbOrder.timestamp).getTime()) / 1000)
                }));
                renderOrders();
                updateLoadIndicator();
                detectBottlenecks();
            }
        }

        // ============================================
        // BOTTLENECK DETECTION
        // ============================================
        function detectBottlenecks() {
            const counts = {};
            orders.forEach(o => {
                o.items.forEach(i => {
                    counts[i.name] = (counts[i.name] || 0) + i.quantity;
                });
            });

            for (let item in counts) {
                if (counts[item] >= 5) { 
                    showBottleneckAlert(item, counts[item]);
                    return;
                }
            }
        }

        function showBottleneckAlert(item, count) {
            const toast = document.getElementById('bottleneckToast');
            document.getElementById('bottleneckMsg').textContent = `Overload: ${count}x ${item} in queue!`;
            toast.style.display = 'block';
            playSound('bottleneck');
            setTimeout(() => { toast.style.display = 'none'; }, 7000);
        }

        // ============================================
        // UPDATED FILTER LOGIC
        // ============================================
        function filterOrders(filter) {
            currentFilter = filter;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });

            const container = document.getElementById('ordersContainer');
            let filtered = orders;

            if (filter !== 'all') {
                if (['new', 'preparing', 'ready'].includes(filter)) {
                    filtered = orders.filter(o => o.status === filter);
                } else {
                    filtered = orders.filter(o => o.source === filter);
                }
            }
            renderOrders(filtered); 
        }

        // ============================================
        // SYNC STATUS WITH DATABASE
        // ============================================
        async function changeStatus(orderId, newStatus) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            const { error } = await _supabase
                .from('orders')
                .update({ status: newStatus })
                .eq('id', orderId);

            if (!error) {
                order.status = newStatus;
                if (newStatus === 'completed') {
                    orders = orders.filter(o => o.id !== orderId);
                }
                renderOrders();
                updateLoadIndicator();
                detectBottlenecks();
            }
        }

        // Existing socket.io listener remains the same
    </script>
</body>
</html>
